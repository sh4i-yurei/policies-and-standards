name: "Gate C - Code Quality"

on:
  workflow_call:
    inputs:
      language:
        description: "Primary language (python|node|rust|java)"
        required: true
        type: string
      working-directory:
        description: "Working directory for commands"
        required: false
        type: string
        default: "."

jobs:
  python:
    if: inputs.language == 'python'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-lint-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
          restore-keys: |
            pip-lint-${{ runner.os }}-
      - name: Install tools
        run: pip install ruff black mypy
      - name: Ruff check
        run: ruff check .
      - name: Black check
        run: black --check .
      - name: Mypy check
        run: mypy . --ignore-missing-imports

  node:
    if: inputs.language == 'node'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json
      - name: Install dependencies
        run: npm ci
      - name: ESLint
        run: npx eslint .
      - name: Prettier check
        run: npx prettier --check .

  rust:
    if: inputs.language == 'rust'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ inputs.working-directory }}/target
          key: cargo-lint-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-lint-${{ runner.os }}-
      - name: Format check
        run: cargo fmt --check
      - name: Clippy
        run: cargo clippy -- -D warnings

  java:
    if: inputs.language == 'java'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "maven"
      - name: Checkstyle
        run: mvn checkstyle:check
