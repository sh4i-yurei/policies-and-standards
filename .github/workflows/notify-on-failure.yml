# CI failure notification — STD-030
#
# Reusable workflow that notifies on CI failures. Vendor-agnostic:
# defaults to GitHub issue creation, optionally sends a webhook.
#
# Called by other workflows using `if: failure()` or as a standalone
# notification mechanism for post-merge and scheduled runs.

name: "Notify on Failure"

on:
  workflow_call:
    inputs:
      gate-name:
        description: "Name of the failed gate or check"
        required: true
        type: string
      pr-number:
        description: "PR number (if applicable)"
        required: false
        type: string
        default: ""
      error-summary:
        description: >-
          Brief description of the failure. Defaults to
          a generic message if omitted.
        required: false
        type: string
        default: "CI gate failed. Check the run logs."
      severity:
        description: "Failure severity (required|advisory)"
        required: false
        type: string
        default: "required"
      create-issue:
        description: "Create a GitHub issue for the failure"
        required: false
        type: boolean
        default: true
      send-webhook:
        description: >-
          Send a webhook notification. Requires
          CI_NOTIFY_WEBHOOK secret to be configured.
        required: false
        type: boolean
        default: false
    secrets:
      CI_NOTIFY_WEBHOOK:
        description: >-
          Webhook URL for notifications (Slack, Discord,
          Teams, or any webhook consumer).
        required: false

jobs:
  create-issue:
    name: "Create failure issue"
    if: inputs.create-issue && inputs.severity == 'required'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create or update failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const gate = '${{ inputs.gate-name }}';
            const pr = '${{ inputs.pr-number }}';
            const summary = '${{ inputs.error-summary }}';
            const sha = context.sha.substring(0, 7);
            const runUrl = [
              context.serverUrl,
              context.repo.owner,
              context.repo.repo,
              'actions/runs',
              context.runId
            ].join('/');

            const prRef = pr ? ` (PR #${pr})` : '';
            const title = `CI failure: ${gate}${prRef}`;

            // Deduplicate open issues for same gate
            const existing =
              await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'type:ci',
                per_page: 20
              });

            const dup = existing.data.find(i =>
              i.title.startsWith(`CI failure: ${gate}`)
            );

            if (dup) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: dup.number,
                body: [
                  `**Repeated failure** at ${sha}`,
                  `Run: ${runUrl}`,
                  `Summary: ${summary}`
                ].join('\n')
              });
              core.info(`Updated issue #${dup.number}`);
              return;
            }

            const body = [
              `## CI failure: ${gate}`,
              '',
              '| Field | Value |',
              '|-------|-------|',
              `| Gate | ${gate} |`,
              pr ? `| PR | #${pr} |` : null,
              `| Commit | ${sha} |`,
              `| Severity | ${
                '${{ inputs.severity }}'
              } |`,
              `| Run | [Logs](${runUrl}) |`,
              '',
              '### Error summary',
              '',
              summary,
              '',
              '### Resolution',
              '',
              'Per STD-030: required gate failures',
              'block merge. Check the run logs.',
              '',
              '---',
              '*Auto-created by CI notification.*'
            ].filter(Boolean).join('\n');

            const labels = ['type:ci'];
            if ('${{ inputs.severity }}' === 'required') {
              labels.push('priority:high');
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });

  send-webhook:
    name: "Send webhook notification"
    if: inputs.send-webhook
    runs-on: ubuntu-latest
    steps:
      - name: Send webhook
        env:
          WEBHOOK_URL: ${{ secrets.CI_NOTIFY_WEBHOOK }}
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "::warning::No CI_NOTIFY_WEBHOOK secret"
            exit 0
          fi

          GATE="${{ inputs.gate-name }}"
          PR="${{ inputs.pr-number }}"
          SUMMARY="${{ inputs.error-summary }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.run_id }}"
          SERVER="${{ github.server_url }}"
          RUN_URL="${SERVER}/${REPO}/actions/runs/${RUN_ID}"

          PR_REF=""
          if [ -n "$PR" ]; then
            PR_REF=" (PR #${PR})"
          fi

          # Generic JSON payload — works with Slack,
          # Discord, and most webhook consumers
          PAYLOAD=$(jq -n \
            --arg text "CI failure: ${GATE}${PR_REF}" \
            --arg repo "$REPO" \
            --arg sha "$SHORT_SHA" \
            --arg sev "${{ inputs.severity }}" \
            --arg url "$RUN_URL" \
            --arg sum "$SUMMARY" \
            '{
              text: $text,
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: ("*" + $text + "*")
                  }
                },
                {
                  type: "section",
                  fields: [
                    {type:"mrkdwn",text:("*Repo:*\n"+$repo)},
                    {type:"mrkdwn",text:("*Commit:*\n"+$sha)},
                    {type:"mrkdwn",text:("*Severity:*\n"+$sev)},
                    {type:"mrkdwn",text:("*Logs:*\n<"+$url+"|View>")}
                  ]
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: ("*Summary:*\n" + $sum)
                  }
                }
              ]
            }')

          HTTP_CODE=$(curl -s -o /dev/null \
            -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$WEBHOOK_URL")

          if [ "$HTTP_CODE" -ge 200 ] && \
             [ "$HTTP_CODE" -lt 300 ]; then
            echo "Webhook sent (HTTP $HTTP_CODE)"
          else
            echo "::warning::Webhook HTTP $HTTP_CODE"
            sleep 2
            curl -s -X POST \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$WEBHOOK_URL" || true
          fi
