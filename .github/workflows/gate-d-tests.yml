name: "Gate D - Tests"

on:
  workflow_call:
    inputs:
      language:
        description: "Primary language (python|node|rust|java)"
        required: true
        type: string
      working-directory:
        description: "Working directory for commands"
        required: false
        type: string
        default: "."

jobs:
  python:
    if: inputs.language == 'python'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-test-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt') }}
          restore-keys: |
            pip-test-${{ runner.os }}-
      - name: Install dependencies
        run: |
          pip install pytest pytest-json-report pytest-cov
          [ -f requirements.txt ] && pip install -r requirements.txt || true
          [ -f requirements-dev.txt ] && pip install -r requirements-dev.txt || true
          [ -f pyproject.toml ] && pip install -e ".[dev]" 2>/dev/null || true
      - name: Run tests
        run: |
          pytest \
            --json-report --json-report-file=results.json \
            --tb=short -v
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-python
          path: ${{ inputs.working-directory }}/results.json

  node:
    if: inputs.language == 'node'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npx vitest run --reporter=json --outputFile=results.json
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-node
          path: ${{ inputs.working-directory }}/results.json

  rust:
    if: inputs.language == 'rust'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: cargo-test-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-test-${{ runner.os }}-
      - name: Install cargo-nextest
        run: cargo install cargo-nextest
      - name: Run tests
        run: cargo nextest run --message-format libtest-json-plus 2>&1 | tee results.json
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-rust
          path: ${{ inputs.working-directory }}/results.json

  java:
    if: inputs.language == 'java'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "maven"
      - name: Run tests
        run: mvn test
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-java
          path: ${{ inputs.working-directory }}/target/surefire-reports/
